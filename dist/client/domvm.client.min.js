// https://github.com/leeoniya/domvm (3.x-dev, client build)
!function(n,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):n.domvm=e()}(this,function(){"use strict";var n=1,e=2,t=3,l=4,r=5,o="undefined"!=typeof window,i=o?window:{},a=o?document:{},u=i.requestAnimationFrame,f={};function d(){}var s=Array.isArray;function c(n){return null!=n&&n.constructor===Object}function v(n){return"function"==typeof n}function y(n){for(var e=arguments,t=1;t<e.length;t++)for(var l in e[t])n[l]=e[t][l];return n}function p(n,e){for(var t=[],l=e;l<n.length;l++)t.push(n[l]);return t}function h(n,e){for(var t in n)if(n[t]!==e[t])return!1;return!0}function m(n,e){var t=n.length;if(e.length!==t)return!1;for(var l=0;l<t;l++)if(n[l]!==e[l])return!1;return!0}function b(n){if(!u)return n;var e,t,l;function r(){e=0,n.apply(t,l)}return function(){t=this,l=arguments,e||(e=u(r))}}function g(n){return"o"===n[0]&&"n"===n[1]}function k(n){return"_"===n[0]}function _(n){return"style"===n}function w(n){n&&n.el&&n.el.offsetHeight}function x(n){return null!=n.node&&null!=n.node.el}function N(n,e){switch(e){case"value":case"checked":case"selected":return!0}return!1}function S(n){for(n=n||f;null==n.vm&&n.parent;)n=n.parent;return n.vm}function C(){}var A=C.prototype={constructor:C,type:null,vm:null,key:null,ref:null,data:null,hooks:null,ns:null,el:null,tag:null,attrs:null,body:null,flags:0,_class:null,_diff:null,_dead:!1,_lis:!1,idx:null,parent:null};function E(n){var t=new C;return t.type=e,t.body=n,t}var R=function(){return!1},O=d,I=d,V=d;function D(n,e){var t=I(n,function(n){t&&(null!=e.node&&e.redraw(),V(t))});return O(n)}function j(n,e){var t=I(n,function(n){t&&null!=e.node&&e.redraw()});return t}var M={},T=/\[(\w+)(?:=(\w+))?\]/g;var L=1,U=2,z=4,F=8;function G(e,t,l,r){var o=new C;o.type=n,o.flags=r||0,o.attrs=t||null;var i=function(n){var e,t,l,r,o=M[n];if(null==o)for(M[n]=o={tag:(e=n.match(/^[-\w]+/))?e[0]:"div",id:(t=n.match(/#([-\w]+)/))?t[1]:null,class:(l=n.match(/\.([-\w.]+)/))?l[1].replace(/\./g," "):null,attrs:null};r=T.exec(n);)null==o.attrs&&(o.attrs={}),o.attrs[r[1]]=r[2]||"";return o}(e);o.tag=i.tag;var a=null!=i.id,u=null!=i.class,f=null!=i.attrs;if(a||u||f){var d=o.attrs||{};if(a&&null==d.id&&(d.id=i.id),u&&(o._class=i.class,d.class=i.class+(null!=d.class?" "+d.class:"")),f)for(var s in i.attrs)null==d[s]&&(d[s]=i.attrs[s]);o.attrs=d}var c=o.attrs;return null!=c&&(null!=c._key&&(o.key=c._key),null!=c._ref&&(o.ref=c._ref),null!=c._hooks&&(o.hooks=c._hooks),null!=c._data&&(o.data=c._data),null!=c._flags&&(o.flags=c._flags),null==o.key&&(null!=o.ref?o.key=o.ref:null!=c.id?o.key=c.id:null!=c.name&&(o.key=c.name+("radio"===c.type||"checkbox"===c.type?c.value:"")))),null!=l&&(o.body=l),o}function P(n,t,o,i){if(n.type!==r&&n.type!==l){var a,u,f;n.parent=t,n.idx=o,n.vm=i,null!=n.ref&&(a=S(n),u=n.ref,f=n,function(n,e,t){for(var l;l=e.shift();)0===e.length?n[l]=t:n[l]=n=n[l]||{}}(a,["refs"].concat(u.split(".")),f));var d=n.hooks,c=i&&i.hooks;(d&&(d.willRemove||d.didRemove)||c&&(c.willUnmount||c.didUnmount))&&function(n){for(;n=n.parent;)n.flags|=L}(n),s(n.body)?function(n){for(var t=n.body,l=0;l<t.length;l++){var r=t[l];!1===r||null==r?t.splice(l--,1):s(r)?(i=r,a=l--,u=1,(o=t).splice.apply(o,[a,u].concat(i))):(null==r.type&&(t[l]=r=E(""+r)),r.type===e?null==r.body||""===r.body?t.splice(l--,1):l>0&&t[l-1].type===e?(t[l-1].body+=r.body,t.splice(l--,1)):P(r,n,l,null):P(r,n,l,null))}var o,i,a,u}(n):""===n.body?n.body=null:R(n.body)&&(n.body=D(n.body,S(n)))}}var W={animationIterationCount:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridRow:!0,gridColumn:!0,order:!0,lineClamp:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0};function Y(n,e){var t,l,r,o=(n.attrs||f).style,i=e?(e.attrs||f).style:null;if(null==o||("string"===(r=typeof o)||"number"===r))n.el.style.cssText=o;else{for(var a in o){var u=o[a];R(u)&&(o[a]=u=D(u,S(n))),(null==i||null!=u&&u!==i[a])&&(n.el.style[a]=(t=a,l=u,isNaN(l)||W[t]?l:l+"px"))}if(i)for(var d in i)null==o[d]&&(n.el.style[d]="")}}var B=[];function H(n,e,t,l,r){if(null!=n){var o=t.hooks[e];if(o){if("d"!==e[0]||"i"!==e[1]||"d"!==e[2])return o(t,l);r?w(t.parent)&&o(t,l):B.push([o,t,l])}}}function q(n){var e;if(B.length)for(w(n.node);e=B.shift();)e[0](e[1],e[2])}function K(n){return n.nextSibling}function X(n,e,t){var l=e._node,r=l.vm;if(s(l.body))if((l.flags&L)===L)for(var o=0;o<l.body.length;o++)X(e,l.body[o].el);else J(l);delete e._node,n.removeChild(e),H(l.hooks,"didRemove",l,null,t),null!=r&&(H(r.hooks,"didUnmount",r,r.data,t),r.node=null)}function Z(n,e){var t=e._node;if(!t._dead){var l,r,o,i,a=function n(e){var t=e.vm,l=null!=t&&H(t.hooks,"willUnmount",t,t.data),r=H(e.hooks,"willRemove",e);if((e.flags&L)===L&&s(e.body))for(var o=0;o<e.body.length;o++)n(e.body[o]);return l||r}(t);null!=a&&("object"==typeof(i=a)&&v(i.then))?(t._dead=!0,a.then((l=X,r=[n,e,!0],function(){return l.apply(o,r)}))):X(n,e)}}function J(n){for(var e=n.body,t=0;t<e.length;t++){var l=e[t];delete l.el._node,null!=l.vm&&(l.vm.node=null),s(l.body)&&J(l)}}function Q(n){var e=n.el;if(0==(n.flags&L))s(n.body)&&J(n),e.textContent=null;else{var t=e.firstChild;do{var l=K(t);Z(e,t)}while(t=l)}}function $(n,e,t){var l=e._node,r=null!=e.parentNode,o=e!==t&&r?null:l.vm;null!=o&&H(o.hooks,"willMount",o,o.data),H(l.hooks,r?"willReinsert":"willInsert",l),n.insertBefore(e,t),H(l.hooks,r?"didReinsert":"didInsert",l),null!=o&&H(o.hooks,"didMount",o,o.data)}function nn(n,e,t){$(n,e,t?K(t):null)}var en={};var tn=d,ln=!1;function rn(n,e,t){n[e]=t}function on(n,e,t,l,r){var o=n.apply(r,e.concat([t,l,r,r.data]));r.onevent(t,l,r,r.data,e),tn.call(null,t,l,r,r.data,e),!1===o&&(t.preventDefault(),t.stopPropagation())}function an(n){var e,t,l=function(n){for(;null==n._node;)n=n.parentNode;return n._node}(n.target),r=S(l),o=n.currentTarget._node.attrs["on"+n.type];if(s(o))on(e=o[0],t=o.slice(1),n,l,r);else for(var i in o)if(n.target.matches(i)){var a=o[i];s(a)?(e=a[0],t=a.slice(1)):(e=a,t=[]),on(e,t,n,l,r)}}function un(n,e,t,l){if(t!==l){var r=n.el;null==t||v(t)?rn(r,e,t):null==l&&rn(r,e,an)}}function fn(n,e,t,l,r){var o=n.el;null!=n.ns?o.setAttribute(e,t):"class"===e?o.className=t:"id"===e||"boolean"==typeof t||l?o[e]=t:"."===e[0]?o[e.substr(1)]=t:o.setAttribute(e,t)}function dn(n,e,t){var l,r,o,i=n.attrs||f,a=e.attrs||f;if(i===a);else{for(var u in i){var d=i[u];if(null!=d){var s=N(n.tag,u),c=s?n.el[u]:a[u];R(d)&&(i[u]=d=D(d,S(n))),d===c||(_(u)?Y(n,e):k(u)||(g(u)?un(n,u,d,c):fn(n,u,d,s)))}}for(var u in a)null==i[u]&&!k(u)&&(l=n,r=u,o=N(n.tag,u)||g(u),"."===r[0]&&(r=r.substr(1),o=!0),o?l.el[r]="":l.el.removeAttribute(r))}}function sn(n,e,t,r){return n.type===l&&(e=n.data,t=n.key,r=n.opts,n=n.view),new Sn(n,e,t,r)}function cn(n){for(var e=0;e<n.body.length;e++){var o=n.body[e],i=o.type;if(i<=t)$(n.el,vn(o));else if(i===l){i=(a=sn(o.view,o.data,o.key,o.opts)._redraw(n,e,!1)).node.type,$(n.el,vn(a.node))}else if(i===r){var a;(a=o.vm)._redraw(n,e),i=a.node.type,$(n.el,a.node.el)}}}function vn(l,r){var o,i,u,d;return null==l.el&&(l.type===n?(l.el=r||(u=l.tag,null!=(d=l.ns)?a.createElementNS(d,u):a.createElement(u)),null!=l.attrs&&dn(l,f),(l.flags&F)===F&&l.body.body(l),s(l.body)?cn(l):null!=l.body&&(l.el.textContent=l.body)):l.type===e?l.el=r||(i=l.body,a.createTextNode(i)):l.type===t&&(l.el=r||(o=l.body,a.createComment(o)))),l.el._node=l,l.el}var yn=1,pn=2;function hn(n,e,t,l,r,o,i,a){return function(u,f,d,s,c,v){var y,p;if(null!=s[l]){if(null==(y=s[l]._node))return void(s[l]=n(s[l]));if(y.parent!==u)return p=n(s[l]),null!=y.vm?y.vm.unmount(!0):Z(f,s[l]),void(s[l]=p)}if(s[r]==c)return pn;if(null==s[r].el)t(f,vn(s[r]),s[l]),s[r]=e(s[r],d);else if(s[r].el===s[l])s[r]=e(s[r],d),s[l]=n(s[l]);else{if(v||y!==s[i])return v&&null!=s[l]?function(n,e,t,l,r,o,i,a,u){if(a._lis)t(o,u[r].el,u[l]),u[r]=e(u[r],i);else{var f=function(n,e){var t,l=0,r=e.length-1;if(r<=2147483647)for(;l<=r;){if(e[t=l+r>>1]===n)return t;e[t]<n?l=t+1:r=t-1}else for(;l<=r;){if(e[t=Math.floor((l+r)/2)]===n)return t;e[t]<n?l=t+1:r=t-1}return l==e.length?null:l}(a.idx,u.tombs);a._lis=!0;var d=n(u[l]);t(o,u[l],null!=f?i[u.tombs[f]].el:f),null==f?u.tombs.push(a.idx):u.tombs.splice(f,0,a.idx),u[l]=d}}(n,e,t,l,r,f,d,y,s):yn;p=s[l],s[l]=n(p),a(f,p,s[o]),s[o]=p}}}var mn=hn(K,function(n,e){return e[n.idx+1]},$,"lftSib","lftNode","rgtSib","rgtNode",nn),bn=hn(function(n){return n.previousSibling},function(n,e){return e[n.idx-1]},nn,"rgtSib","rgtNode","lftSib","lftNode",$);function gn(n,e,t,l){for(var r=[],o=r.slice.call(e.childNodes),i=0;i<o.length;i++){var a=o[i]._node;a.parent===n&&r.push(a.idx)}for(var u=function(n){var e,t,l=n.slice(),r=[];r.push(0);for(var o=0,i=n.length;o<i;++o){var a=r[r.length-1];if(n[a]<n[o])l[o]=a,r.push(o);else{for(e=0,t=r.length-1;e<t;){var u=(e+t)/2|0;n[r[u]]<n[o]?e=u+1:t=u}n[o]<n[r[e]]&&(e>0&&(l[o]=r[e-1]),r[e]=o)}}for(t=r[(e=r.length)-1];e-- >0;)r[e]=t,t=l[t];return r}(r).map(function(n){return r[n]}),f=0;f<u.length;f++)t[u[f]]._lis=!0;for(l.tombs=u;;){if(mn(n,e,t,l,null,!0)===pn)break}}function kn(n){return n.el._node.parent!==n.parent}function _n(n,e,t){return e[t]}function wn(n,e,t){for(;t<e.length;t++){var o=e[t];if(null!=o.vm){if(n.type===l&&o.vm.view===n.view&&o.vm.key===n.key||n.type===r&&o.vm===n.vm)return o}else if(!kn(o)&&n.tag===o.tag&&n.type===o.type&&n.key===o.key&&(n.flags&~L)==(o.flags&~L))return o}return null}function xn(n,e,t){if(null==e._keys){if(e[t].key===n.key)return e[t];for(var l={},r=0;r<e.length;r++)l[e[r].key]=r;e._keys=l}return e[e._keys[n.key]]}function Nn(o,i){H(i.hooks,"willRecycle",i,o);var a=o.el=i.el,u=i.body,c=o.body;if(a._node=o,o.type!==e||c===u){null==o.attrs&&null==i.attrs||dn(o,i);var v=s(u),y=s(c),p=(o.flags&F)===F;v?y||p?function(e,o){var i=e.body,a=i.length,u=o.body,s=u.length,c=(e.flags&F)===F,v=(e.flags&U)===U,y=(e.flags&z)===z,p=!v&&e.type===n,h=!0,m=0===s?d:y?xn:v||c?_n:wn;if(p&&0===a)return Q(o),void(c&&(e.body=[]));var b,g,k=0,_=!1,w=0;if(c)var N={key:null},S=Array(a);for(var C=0;C<a;C++){if(c){var A=!1,E=null;h&&(y&&(N.key=i.key(C)),b=m(N,u,w)),null!=b?(g=b.idx,!0===(E=i.diff(C,b))?((R=b).parent=e,R.idx=C,R._lis=!1):A=!0):A=!0,A&&(P(R=i.tpl(C),e,C),R._diff=null!=E?E:i.diff(C),null!=b&&Nn(R,b)),S[C]=R}else{var R=i[C],O=R.type;if(O<=t)(b=h&&m(R,u,w))&&(Nn(R,b),g=b.idx);else if(O===l){if(b=h&&m(R,u,w)){g=b.idx;var I=b.vm._update(R.data,e,C)}else var I=sn(R.view,R.data,R.key,R.opts)._redraw(e,C,!1);O=I.node.type}else if(O===r){var V=x(R.vm),I=R.vm._update(R.data,e,C,V);O=I.node.type}}if(null!=b&&(g===w?++w===s&&a>s&&(b=null,h=!1):_=!0,!y&&s>100&&_&&++k%10==0))for(;w<s&&kn(u[w]);)w++}c&&(e.body=S);p&&function(n,e){var t=e.body,l=n.el,r=n.body,o={lftNode:r[0],rgtNode:r[r.length-1],lftSib:(t[0]||f).el,rgtSib:(t[t.length-1]||f).el};n:for(;;){for(;;){var i=mn(n,l,r,o,null,!1);if(i===yn)break;if(i===pn)break n}for(;;){var a=bn(n,l,r,o,o.lftNode,!1);if(a===yn)break;if(a===pn)break n}gn(n,l,r,o);break}}(e,o)}(o,i):c!==u&&(null!=c?a.textContent=c:Q(i)):y?(Q(i),cn(o)):c!==u&&(null!=c&&null!=u?a.firstChild.nodeValue=c:a.textContent=c),H(i.hooks,"didRecycle",i,o)}else a.nodeValue=c}function Sn(n,e,t,l){var r=this;r.view=n,r.data=e,r.key=t,R(e)&&(r._stream=j(e,r)),l&&(r.opts=l,r.config(l));var o=c(n)?n:n.call(r,r,e,t,l);v(o)?r.render=o:(r.render=o.render,r.config(o)),r._redrawAsync=b(function(n){return r.redraw(!0)}),r._updateAsync=b(function(n){return r.update(n,!0)}),r.init&&r.init.call(r,r,r.data,r.key,l)}var Cn=Sn.prototype={constructor:Sn,_diff:null,init:null,view:null,key:null,data:null,state:null,api:null,opts:null,node:null,hooks:null,onevent:d,refs:null,render:null,mount:function(n,e){var t=this;e?(Q({el:n,flags:0}),t._redraw(null,null,!1),n.nodeName.toLowerCase()!==t.node.tag?(vn(t.node),$(n.parentNode,t.node.el,n),n.parentNode.removeChild(n)):$(n.parentNode,vn(t.node,n),n)):(t._redraw(null,null),n&&$(n,t.node.el));n&&q(t);return t},unmount:function(n){R(this._stream)&&V(this._stream);var e=this.node;Z(e.el.parentNode,e.el),n||q(this)},config:function(n){var e=this;n.init&&(e.init=n.init),n.diff&&(e.diff=n.diff),n.onevent&&(e.onevent=n.onevent),n.hooks&&(e.hooks=y(e.hooks||{},n.hooks)),n.onemit&&(e.onemit=y(e.onemit||{},n.onemit))},parent:function(){return S(this.node.parent)},root:function(){for(var n=this.node;n.parent;)n=n.parent;return n.vm},redraw:function(n){null==n&&(n=ln);return n?this._redraw(null,null,x(this)):this._redrawAsync(),this},update:function(n,e){null==e&&(e=ln);return e?this._update(n,null,null,x(this)):this._updateAsync(n),this},_update:function(n,e,t,l){var r=this;null!=n&&r.data!==n&&(H(r.hooks,"willUpdate",r,n),r.data=n,R(r._stream)&&V(r._stream),R(n)&&(r._stream=j(n,r)));return r._redraw(e,t,l)},_redraw:function(n,e,t){var l,r,o=null==n,i=this,a=i.node&&i.node.el&&i.node.el.parentNode,u=i.node;if(null!=i.diff&&(l=i._diff,i._diff=r=i.diff(i,i.data),null!=u)){var f=s(l)?m:h,d=l===r||f(l,r);if(d)return An(i,u,n,e)}a&&H(i.hooks,"willRedraw",i,i.data);var c=i.render.call(i,i,i.data,l,r);if(c===u)return An(i,u,n,e);i.refs=null,null!=i.key&&c.key!==i.key&&(c.key=i.key);i.node=c,n?(P(c,n,e,i),n.body[e]=c):u&&u.parent?(P(c,u.parent,u.idx,i),u.parent.body[u.idx]=c):P(c,null,null,i);if(!1!==t)if(u)if(u.tag!==c.tag||u.key!==c.key){u.vm=c.vm=null;var v=u.el.parentNode,y=K(u.el);Z(v,u.el),$(v,vn(c),y),u.el=c.el,c.vm=i}else Nn(c,u);else vn(c);a&&H(i.hooks,"didRedraw",i,i.data),o&&a&&q(i);return i},_redrawAsync:null,_updateAsync:null};function An(n,e,t,l){return null!=t&&(t.body[l]=e,e.idx=l,e.parent=t,e._lis=!1),n}function En(n,e,t,l){var r,o;return null==t?c(e)?r=e:o=e:(r=e,o=t),G(n,r,o,l)}var Rn="http://www.w3.org/2000/svg";function On(n,e,t,l){this.view=n,this.data=e,this.key=t,this.opts=l}function In(n){this.vm=n}On.prototype={constructor:On,type:l,view:null,data:null,key:null,opts:null},In.prototype={constructor:In,type:r,vm:null};var Vn={config:function(n){var e,t;tn=n.onevent||tn,null!=n.syncRedraw&&(ln=n.syncRedraw),n.onemit&&(e=n.onemit,y(en,e)),n.stream&&(t=n.stream,R=t.is,O=t.val,I=t.sub,V=t.unsub)},ViewModel:Sn,VNode:C,createView:sn,defineElement:En,defineSvgElement:function(n,e,t,l){var r=En(n,e,t,l);return r.ns=Rn,r},defineText:E,defineComment:function(n){var e=new C;return e.type=t,e.body=n,e},defineView:function(n,e,t,l){return new On(n,e,t,l)},injectView:function(n){return new In(n)},injectElement:function(e){var t=new C;return t.type=n,t.el=t.key=e,t},lazyList:function(n,e){var t=n.length,l={items:n,length:t,key:function(t){return e.key(n[t],t)},diff:function(t,l){var r=e.diff(n[t],t);if(null==l)return r;var o=l._diff;return(r===o||s(o)?m(r,o):h(r,o))||r},tpl:function(t){return e.tpl(n[t],t)},map:function(n){return e.tpl=n,l},body:function(n){for(var e=Array(t),r=0;r<t;r++){var o=l.tpl(r);o._diff=l.diff(r),e[r]=o,P(o,n,r)}n.body=e}};return l},FIXED_BODY:U,DEEP_REMOVE:L,KEYED_LIST:z,LAZY_LIST:F};function Dn(n){var e,t,l=arguments,r=l.length;if(r>1){var o=1;c(l[1])&&(t=l[1],o=2),e=r!==o+1||l[o]instanceof C||l[o]instanceof On||l[o]instanceof In?p(l,o):l[o]}return G(n,t,e)}return A.patch=function(n,e){!function(n,e,t){if(null!=e.type){if(null!=n.vm)return;P(e,n.parent,n.idx,null),n.parent.body[n.idx]=e,Nn(e,n),t&&w(e),q(S(e))}else{var l=Object.create(n);l.attrs=y({},n.attrs);var r=y(n.attrs,e);if(null!=n._class){var o=r.class;r.class=null!=o&&""!==o?n._class+" "+o:n._class}dn(n,l),t&&w(n)}}(this,n,e)},Cn.emit=function(n){var e=this,t=e,l=p(arguments,1).concat(t,t.data);do{var r=e.onemit,o=r?r[n]:null;if(o){o.apply(e,l);break}}while(e=e.parent());en[n]&&en[n].apply(e,l)},Cn.onemit=null,Cn.body=function(){return function n(e,t){var l=e.body;if(s(l))for(var r=0;r<l.length;r++){var o=l[r];null!=o.vm?t.push(o.vm):n(o,t)}return t}(this.node,[])},Vn.defineElementSpread=Dn,Vn.defineSvgElementSpread=function(){var n=Dn.apply(null,arguments);return n.ns=Rn,n},Cn._stream=null,Cn.attach=function(n){return null==this.node&&this._redraw(null,null,!1),function n(e,t){e.el=t,t._node=e;var o=e.attrs;for(var i in o){var a=o[i],u=N(e.tag,i);_(i)||k(i)||(g(i)?un(e,i,a):null!=a&&u&&fn(e,i,a,u))}if((e.flags&F)===F&&e.body.body(e),s(e.body)&&e.body.length>0)for(var f=t.firstChild,d=0,c=e.body[d];c.type===l?c=sn(c.view,c.data,c.key,c.opts)._redraw(e,d,!1).node:c.type===r&&(c=c.node||c._redraw(e,d,!1).node),n(c,f),(f=f.nextSibling)&&(c=e.body[++d]););}(this.node,n),this},Vn});